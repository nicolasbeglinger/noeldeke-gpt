{% extends 'base.html' %} {% load static %} {% block content %}
<div class="container">
    <h1 class="mt-4 text-left">Karte</h1>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/leaflet-tilelayer-swiss@2.3.0/dist/Leaflet.TileLayer.Swiss.umd.js"
        crossorigin
        integrity="sha384-M4p8VfZ8RG6qNiPYA3vOCApQXAlLtnJXVPdydMYPAsvvIDsWp2dqqzF2OEeWWNhy"
    ></script>

    <body>
        <div id="mapid" style="height: 75vh"></div>
        <script>
            // Define LV95
            var lv95 = {
                epsg: "EPSG:2056",
                def: "+proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs",
                resolutions: [
                    8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2,
                    1, 0.5, 0.25, 0.125, 0.0625,
                ],
                origin: [2420000, 1350000],
            };

            var crs = new L.Proj.CRS(lv95.epsg, lv95.def, {
                resolutions: lv95.resolutions,
                origin: lv95.origin,
            });
            var map = new L.Map("mapid", {
                crs: crs,
                maxZoom: 15,
                minZoom: 10,
            }).setView(
                L.CRS.EPSG2056.unproject(L.point(2718572.19, 1200165.34)),
                13
            );

            const url =
                "https://wms.geo.admin.ch/?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities";
            const mapOptions = {
                layers: "ch.swisstopo.pixelkarte-farbe",
            };
            const wmsLayer = L.tileLayer.wms(url, mapOptions).addTo(map);

            var markers = [
                { point: L.point(2718572.19, 1200165.34), popup: "Nöldeke" },
                { point: L.point(2718470.54, 1200117.39), popup: "Tödiblick" },
                {
                    point: L.point(2719254.18, 1200724.44),
                    popup: "Schwettiberg-<br>Lädeli",
                },
            ];

            markers.forEach(function (marker, index) {
                var leafletMarker = L.marker(crs.unproject(marker.point))
                    .bindPopup(marker.popup)
                    .addTo(map);

                if (index == 0) {
                    leafletMarker.openPopup();
                }
            });

            // Define the routes object and layer control
            var routes = {};
            var layerControl = L.control
                .layers(null, routes, { collapsed: false, position: "topleft" })
                .addTo(map);

            // Add a custom title to the layer control
            var layerControlContainer = layerControl.getContainer();
            var layerControlTitle = L.DomUtil.create(
                "div",
                "leaflet-control-layers-title"
            );
            layerControlTitle.innerHTML = "<strong>Wanderungen</strong>";
            layerControlContainer.insertBefore(
                layerControlTitle,
                layerControlContainer.firstChild
            );

            // Function to fetch and add GeoJSON layer
            function addGeoJsonLayer(path, name, color) {
                fetch(path)
                    .then((response) => response.json())
                    .then((data) => {
                        var layer = L.geoJSON(data, {
                            style: {
                                color: color,
                                weight: 4,
                                opacity: 0.6,
                            },
                        });

                        // Add layer to routes object and update layer control
                        routes[name] = layer;
                        layerControl.addOverlay(layer, name);
                    })
                    .catch((err) =>
                        console.error("Error loading GeoJSON:", err)
                    );
            }

            // Add GeoJSON layers
            addGeoJsonLayer(
                "{% static 'map/Noeldeke_Oberblegisee.geojson' %}",
                "Oberblegisee",
                "blue"
            );
            addGeoJsonLayer(
                "{% static 'map/Noeldeke_Gumen.geojson' %}",
                "Gumen",
                "red"
            );
        </script>
    </body>
</div>
{% endblock %}
